name: ğŸš€ Deploy Galaxy Advanced Game

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOTNET_VERSION: '7.0.x'
  NODE_VERSION: '18.x'

jobs:
  build-and-test:
    name: ğŸ—ï¸ Build & Test Galaxy Game
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¯ Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ› ï¸ Build project
      run: dotnet build --configuration Release --no-restore
      
    - name: ğŸ§ª Run tests
      run: dotnet test --verbosity normal --logger "console;verbosity=detailed"
      
    - name: ğŸ“Š Code coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.cobertura.xml

  deploy-android:
    name: ğŸ“± Deploy to Android
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¯ Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ”§ Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ“¦ Install MAUI
      run: |
        dotnet workload install android
        dotnet workload install maui-android
        
    - name: ğŸ—ï¸ Build Android APK
      run: |
        dotnet publish GalaxyAdvancedGame.csproj \
          -c:Release \
          -f:net7.0-android \
          -p:AndroidPackageFormat=apk \
          -p:AndroidSigningKeyPass=keystore_password \
          -p:AndroidSigningStorePass=keystore_password \
          --output ./android-build
          
    - name: ğŸ“± Sign APK
      run: |
        jarsigner -verbose \
          -sigalg SHA256withRSA \
          -digestalg SHA-256 \
          -keystore ./android.keystore \
          ./android-build/com.galaxy.advanced.game-Signed.apk \
          galaxy_game_key
          
    - name: ğŸš€ Deploy to Play Store
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.galaxy.advanced.game
        releaseFiles: ./android-build/*.apk
        track: internal
        status: completed

  deploy-web:
    name: ğŸŒ Deploy to Web
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¯ Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ—ï¸ Build Blazor WebAssembly
      run: |
        dotnet publish GalaxyAdvancedGame.csproj \
          -c:Release \
          -f:net7.0 \
          --output ./web-build
          
    - name: ğŸ“¦ Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "./web-build/wwwroot"
        output_location: "."

  performance-test:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¯ Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ§ª Run performance tests
      run: |
        dotnet run --project PerformanceTests.csproj \
          --configuration Release \
          --logger "console;verbosity=detailed"
          
    - name: ğŸ“Š Upload performance results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: ./performance-results/

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run security scan
      uses: github/codeql-action/analyze@v2
      with:
        languages: csharp, javascript
        
    - name: ğŸ›¡ï¸ Dependency vulnerability scan
      uses: dependency-review-action@v3

  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-android, deploy-web]
    if: always()
    
    steps:
    - name: ğŸ“± Send Telegram notification
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸš€ **Galaxy Advanced Game Deployment**
          
          âœ… Android: ${{ needs.deploy-android.result }}
          âœ… Web: ${{ needs.deploy-web.result }}
          âœ… Performance: ${{ needs.performance-test.result }}
          âœ… Security: ${{ needs.security-scan.result }}
          
          ğŸ“Š Build: ${{ github.run_number }}
          ğŸ”— Commit: ${{ github.sha }}
          
    - name: ğŸ“§ Send email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Galaxy Game Deployment Result"
        body: |
          Deployment completed for Galaxy Advanced Game
          
          Results:
          - Android: ${{ needs.deploy-android.result }}
          - Web: ${{ needs.deploy-web.result }}
          - Build: ${{ github.run_number }}
        to: ${{ secrets.DEPLOYMENT_EMAIL }}
        from: Galaxy Game CI

# ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø±
permissions:
  contents: read
  packages: write
  security-events: write

# Ú©Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ø¹Ù…Ù„Ú©Ø±Ø¯
cache:
  paths:
    - ~/.nuget/packages
    - ~/.android/
    - node_modules/
